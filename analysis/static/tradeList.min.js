$(".msg-switch").bootstrapSwitch(),$("#selectAllLive").click(function(){for(var t=$("#live_table").find("tbody").find("tr"),e=0;e<t.length;e++){var a=$(t[e]).attr("_status");$(t[e]).hasClass("hidden")||"nulltrade"===a||$(t[e]).find(".backtest-checkbox").find("input").prop("checked",this.checked)}$("#live_table").find(".backtest-checkbox").find("input").trigger("change")}),$("#live_table").delegate("input[type=checkbox]","change",function(t){0<$("#live_table").find("tbody").find("input[type=checkbox].select-checkbox:checked").length?$("#del-live").removeClass("disabled"):$("#del-live").addClass("disabled")}),$("#del-live").click(function(){BootstrapDialog.confirm("确定要删除?",function(t){if(t){var a=[];$("#live_table").find("tbody").find("input[type=checkbox]:checked").each(function(t,e){$(e).hasClass("hidden")||a.push($(e.parentNode).attr("_backtestId"))});var e=a.join(",");Cy.ajax("/algorithm/live/del",{data:{backtestId:e},success:function(t){0==t.status?BootstrapDialog.alert("删除成功",function(){window.location.reload()}):BootstrapDialog.alert("删除失败:"+t.msg)}})}})}),$("#all-live").click(function(){return window.location.href=window.location.pathname,!1}),$("#running-live").click(function(){return window.location.href=window.location.pathname+"?process=1",!1}),$("#stop-live").click(function(){return window.location.href=window.location.pathname+"?process=0",!1});var onShowTable=function(){var t=window.location.search,e=$("#live_table").find("tbody").find("tr"),a=["0","1","3","5"];if(!t||t.indexOf("process")<0)$("#all-live").addClass("active"),e.removeClass("hidden");else if(0<=t.indexOf("process=1")){$("#running-live").addClass("active");for(var s=0;s<e.length;s++){var n=(o=$(e[s])).attr("_status");0<=a.indexOf(n)?o.removeClass("hidden"):"nulltrade"!==n&&o.addClass("hidden")}}else if(0<=t.indexOf("process=0")){$("#stop-live").addClass("active");for(s=0;s<e.length;s++){var o;n=(o=$(e[s])).attr("_status");a.indexOf(n)<0?o.removeClass("hidden"):o.addClass("hidden")}}$("#live_table_div").removeClass("hidden")};onShowTable();var options={animation:!0,trigger:"hover"};$(".atip").tooltip(options),$(".popover-right").popover({placement:"bottom",trigger:"manual",html:!0,content:'开启微信通知后，您可以通过微信接收模拟交易的下单信号。<a href="/faq#open_wechat" target="_blank">如何开启微信通知？</a>'}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)});var switchDisabled=!1,wechatDialog=null,toBindSwitchBtn=null,wechatNoticeMark='<span id="wechat-scan"><i style="color:#ffcf0d;font-size:18px" class="icon  icon-exclamation-sign"></i>&nbsp;&nbsp;您还没有绑定微信</span><br/><span>请使用微信扫一扫，关注JoinQuant公众号进行绑定</span>',checkBindStatusEnable=!0;function checkBindStatus(timestamp){0!=checkBindStatusEnable&&$.get("/user/wechat/bindStatus",function(res,status){if(res=eval("("+res+")"),"ok"==res.data.bindState){if(void 0!==timestamp&&res.data.subTime<timestamp)return void setTimeout("checkBindStatus("+timestamp+")",1e3);var html='<span style="color:green;font-size:16px"><i class="icon icon-ok-sign" style="font-size:18px"></i>&nbsp;&nbsp;恭喜您，绑定成功!</span><br/><br/><p style="text-align:left;padding:0 20px 0 20px">接下来，您可以开启微信通知，模拟交易下单信号会第一时间通过微信通知您。</p><img src="'+g_staticHost+'/algorithm/img/wechat_notice_switch.png">';$("#wechat-body").html(html),toBindSwitchBtn&&$(toBindSwitchBtn).bootstrapSwitch("toggleState"),$(".wechat-edit").eq(0).attr("_isBindWechat",1)}else setTimeout("checkBindStatus()",2e3)})}function updateLiveResult(){var t=[];$(".backtest-checkbox").each(function(){1!=$(this.parentNode).attr("_status")&&5!=$(this.parentNode).attr("_status")||t.push($(this).attr("_backtestId"))});var e=t.join(",");Cy.ajax("/algorithm/live/stats?offset=-1&limit=1&backtestIds="+e,{fail:function(){},success:function(t){if(t.data)for(var e=0;e<t.data.length;e++){var a=t.data[e].backtestId;if(0<t.data[e].stat.max_drawdown.value.length){var s=(100*parseFloat(t.data[e].stat.max_drawdown.value[0])).toFixed(2)+"%";$("#max-drawdown-"+a).html('<span class="nodisplay grey">最大回撤</span>'+s)}if(0<t.data[e].stat.intraday_return.value.length){var n=$("#live-today-"+a);if(!n.attr("is-delay-trade")){var o=(100*parseFloat(t.data[e].stat.intraday_return.value[0])).toFixed(2);n.html('<span class="nodisplay grey">今日收益</span>'+o+"%"),0<o?n.addClass("red"):o<0&&n.addClass("green")}}if(0<t.data[e].stat.annual_algo_return.value.length){var i=(100*parseFloat(t.data[e].stat.annual_algo_return.value[0])).toFixed(2);$("#year-return-"+a).html('<span class="nodisplay grey">今日收益</span>'+i+"%"),0<i?$("#year-return-"+a).addClass("red"):i<0&&$("#year-return-"+a).addClass("green")}}}}),Cy.ajax("/algorithm/backtest/currentResult?backtestId="+e,{error:function(t){},fail:function(){},success:function(t){for(var e=0;e<t.data.length;e++){var a=t.data[e].backtestId,s=t.data[e].result;""!==s&&null!=s&&$("#live-result-"+a).html('<span class="nodisplay grey">收益</span>'+s+"%"),s<0?$("#live-result-"+a).addClass("green"):0<s&&$("#live-result-"+a).addClass("red")}}})}$(".msg-switch").on("switchChange.bootstrapSwitch",function(t,e){var a=$(this),s=a.attr("is-delay-trade");if(e&&s)return BootstrapDialog.show({title:"提示",message:"当前为延时模拟交易，不支持微信通知。"}),void a.bootstrapSwitch("toggleState");if(toBindSwitchBtn=null,!switchDisabled){var n=$(this).attr("_backtestId"),o=this;if(e)var i="enabled";else i="disabled";Cy.ajax("/algorithm/live/setNotice",{data:{backtestId:n,enable:i},error:function(t){},success:function(t){"ok"!=t.data.state&&(switchDisabled=!0,$(o).bootstrapSwitch("toggleState"),setTimeout("switchDisabled=false;",300),toBindSwitchBtn=o,"noway"==t.data.state&&(BootstrapDialog.show({title:"绑定微信",btnOKLabel:"确认",cssClass:"wechat-dialog",onshown:function(t){wechatDialog=t},onhidden:function(t){checkBindStatusEnable=!1},message:'<div id="wechat-body">'+wechatNoticeMark+'<img width="300" id="wechat-img" src="'+t.data.qrCode+'"></div>'}),checkBindStatusEnable=!0,setTimeout("checkBindStatus()",3e3)))}})}}),$(".wechat-edit").click(function(){toBindSwitchBtn=null;var a=$(this).attr("_isBindWechat");Cy.ajax("/user/wechat/bindQrCode",{error:function(t){},success:function(t){if("ok"!=t.data.state){1==a?BootstrapDialog.show({title:"绑定微信",btnOKLabel:"确认",cssClass:"wechat-dialog",onshown:function(t){wechatDialog=t},onhidden:function(t){checkBindStatusEnable=!1},message:'<div id="wechat-body"><span>您已绑定微信</span><br/><span id="wechat-scan">可以用微信扫一扫，重新绑定</span><img width="300" id="wechat-img" src="'+t.data.qrCode+'"></div>'}):BootstrapDialog.show({title:"绑定微信",btnOKLabel:"确认",cssClass:"wechat-dialog",onshown:function(t){wechatDialog=t},onhidden:function(t){checkBindStatusEnable=!1},message:'<div id="wechat-body">'+wechatNoticeMark+'<img width="300" id="wechat-img" src="'+t.data.qrCode+'"></div>'});var e=Date.parse(new Date)/1e3;checkBindStatusEnable=!0,setTimeout("checkBindStatus("+e+")",3e3)}}})});var popoverContent='<div class="popover-content-dev" ><p class="popover-content-title" >统一参数</p><p>基准： 沪深300</p><p>撮合方式： 盘口撮合。<a href="/view/community/detail/e47dcbe9f0088fca3aabe4fdaaf714cc" target="_blank">查看详细说明</a></p><p>手续费： 买入佣金万分之三，卖出时佣金万分之三加千分之一印花税</p><p class="popover-content-title" style="margin-top:12px">检查配置项</p><p>策略中使用过某些配置项时，将不允许分享到擂台。<a href="/help/api/help?name=api#experimental_settings" target="_blank">查看详细说明</a></p></div>';function initLiveResult(){updateLiveResult(),setTimeout(initLiveResult,3e5)}function popover(t,e){$(t).popover({placement:"bottom",trigger:"manual",html:!0,content:e}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)})}$(".btn-share").click(function(){var t=$(this).attr("_name"),s=$(this).attr("_backtestId");return BootstrapDialog.show({title:"分享策略",cssClass:"btn-share-boot",message:'<div class="mb_20"><span class="vm">策略名称： </span><input id="name" type="text" value="'+t+'" ></div><div class="clear"><span style="vertical-align:top">策略思路： </span><textarea id="introduce" placeholder="请输入策略思路，便于大家了解您的策略" ></textarea><p class="bootips"><span style="color:#a2a6a9;">为了策略擂台的公平性，我们会将您的策略进行</span><span class="share_popover" style="color:#255da8;cursor:pointer">如下设置</span></p></div>',onshown:function(t){$(".share_popover").popover({placement:"bottom",trigger:"manual",html:!0,content:popoverContent}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)}),$("#name").focus(function(){$(this).select()})},buttons:[{label:"取消",action:function(t){t.close()}},{label:"提交",cssClass:"btn-primary",action:function(e){var t=e.getModalBody().find("#name").val(),a=e.getModalBody().find("#introduce").val();Cy.ajax("/algorithm/live/share",{data:"backtestId="+s+"&name="+encodeURIComponent(t)+"&introduce="+encodeURIComponent(a),async:!1,success:function(t){return window.location.reload(),!1},fail:function(t){0<=t.msg.indexOf("系统检查到策略中包含某些不允许开启的配置项")?(e.close(),BootstrapDialog.show({title:"提示",cssClass:"error-dialog",message:t.msg+'<a style="margin-left:10px;" href="/help/api/help?name=api#experimental_settings" target="_blank">查看详细说明</a>',buttons:[{label:"确定",action:function(t){t.close()}}]})):BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})}}]}),!1}),initLiveResult(),$(".backtest-checkbox .select-checkbox").click(function(){$(this).parent().hasClass("un-selectbox")?$(this).parent().addClass("selectbox").removeClass("un-selectbox"):$(this).parent().hasClass("selectbox")&&($(this).parent().addClass("un-selectbox").removeClass("selectbox"),$("#selectAllLive").parent().hasClass("selectbox")&&($("#selectAllLive").prop("checked",!1),$("#selectAllLive").parent().addClass("un-selectbox").removeClass("selectbox")))}),$("#selectAllLive").click(function(){$(this).parent().hasClass("un-selectbox")?$("input[type=checkbox].select-checkbox").parent().addClass("selectbox").removeClass("un-selectbox"):$(this).parent().hasClass("selectbox")&&$("input[type=checkbox].select-checkbox").parent().addClass("un-selectbox").removeClass("selectbox")}),$(".popover-bottom").each(function(t,e){popover(e,$(e).attr("_content"))}),$(document).ready(function(){$(".select-checkbox").attr("disabled",!1)});