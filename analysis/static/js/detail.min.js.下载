var doneFlag=!1,failFlag=!1,liveMinDate=$("#minLiveDate").val(),accessControl=$("#accessControl").val(),flag=!1,tick,positionOffset,onGetResetDataFlag=!0,isInitFlag=!1,algorithmCode,$node=$("body"),algorithmId=$("#algorithmId").val(),pyVersion=$("#tradePyVersion").val(),initDataResult=[],initDataBenchmark=[],backtestAPI=$.extend({positionInfo:"/algorithm/backtest/positionInfo",transactionInfo:"/algorithm/backtest/transactionInfo",log:"/algorithm/backtest/log",errLog:"/algorithm/backtest/error",source:"/algorithm/backtest/source",stats:"/algorithm/backtest/stats",dayResult:"/algorithm/backtest/dayResult",result:"/algorithm/backtest/result",export:"/algorithm/backtest/export",nullBacktestLive:"/algorithm/backtest/nullBacktestLive"},window.backtestAPIByAccess||{}),deepCopy=function(t){if(t instanceof Array){for(var e=[],a=0;a<t.length;++a)e[a]=deepCopy(t[a]);return e}if(t instanceof Object){e={};for(var a in t)e[a]=deepCopy(t[a]);return e}return t},prefixInteger=function(t,e){return(Array(e).join(0)+t).slice(-e)},setRangeAllIndex=function(t){chart.rangeSelector.clickButton(t,{type:"all"},!0)},addExcessMaxDrawdownTag=function(t){chart.addSeries({type:"flags",data:[{x:t[0],title:" ",text:"最大回撤"},{x:t[1],title:" ",text:"最大回撤"}],onSeries:"excessSeries",fillColor:"#56d42a",states:{hover:{fillColor:"#56d42a"}},shape:"circlepin",y:-3,height:4,width:4})},calculateMaxDrawdown=function(t){var a,i,o,n,s,r;return t.map(function(t,e){(!a||t.y>a)&&(a=t.y,n=t.x),i=t.y-a,(!o||i<o)&&(o=i,s=t.x,r=[n,s])}),1-o,r},redrawChart=function(){var e,t,i,a,o,n,s=dataResultBak;n="line"===chartType?(o=0,100):(o=100,0),e=s.filter(function(t,e){if(t.x===new Date(chartNavMinDate).getTime())return t}),besicBenchmark=dataBenchmarkBak.filter(function(t,e){if(t.x===new Date(chartNavMinDate).getTime())return t}),isInit?(t=s.map(function(t){return[t.x,t.y+o]}),i=dataBenchmarkBak.map(function(t){return[t.x,t.y+o]}),a=t.map(function(t,e){var a=i[e]||[];return[t[0],(t[1]+n)/(a[1]+n)*100-n]})):e&&(e=e[0],t=s.map(function(t){return[t.x,(t.y-e.y)/(100+e.y)*100+o]}),i=dataBenchmarkBak.map(function(t){return[t.x,(t.y-besicBenchmark[0].y)/(100+besicBenchmark[0].y)*100+o]}),a=t.map(function(t,e){var a=i[e]||[];return[t[0],(t[1]+n)/(a[1]+n)*100-n]})),chart.series[0].setData(t,!1),chart.series[1].setData(i,!1),chart.series[2].setData(a,!1),chart.redraw()},isInit=!0,chartNavMinDate,chartNavMaxDate,onGetResetData=function(t){for(var e=[],a=dataResult,i=0;i<a.length;i++)e.push(a[i].x);chartNavMinDate=getTick(e,t.min),chartNavMaxDate=getTick(e,t.max),isInit=chartNavMinDate===a[0].x,redrawChart()},getTick=function(n,s){var r;return n.push(s),n.sort(),n.find(function(t,e){if(t===s){if(0===e)r=n[1];else if(e===n.length-1)r=n[n.length-1];else{var a=n[e+1],i=new Date(t).getDate(),o=new Date(a).getDate();i===o?r=n[e+2]:i!==o&&(r=a)}return!0}}),r},paneCodeEditor;function getSourceCode($dom,callback){if("0"==$dom.attr("_isLoad"))if(1==accessControl){if(!g_isWinApp||"undefined"==typeof jsObj)return"#请在客户端打开查看源码";var backtestId=$("#backtestId").attr("backtestId_"),res=jsObj.ReadBacktestCode(backtestId),obj=eval("("+res+")");if("00000"!=obj.code)return"#无法查看源码"+obj.msg;$dom.text(obj.data)}else{var id=$dom.attr("_backtestId");Cy.ajax(backtestAPI.source,{async:!1,data:{backtestId:id},success:function(t){if(403==t.code)return $dom.text("无权限查看");"00000"!==t.code?BootstrapDialog.alert(t.msg):(callback(t.data.source),$dom.text(t.data.source),$dom.attr("_isLoad","1"),algorithmCode=t.data.source,$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"))}})}else callback($dom.text())}$.each($(".enable-when-done"),function(t,e){$(e).css("color","#b3b7bb"),$(e).css("cursor","default")}),$("#view-code-button").click(function(){BootstrapDialog.show({title:"策略代码",btnOKLabel:"确认",cssClass:"code-dialog",message:"",onshown:function(t){var a=$(".bootstrap-dialog-message").eq(0);a.attr("id","code-view");var e=.7*$("body").height();a.css("height",e+"px"),getSourceCode($("#code"),function(t){a.text(t),$(".code-dialog .modal-dialog").css("width","700px");var e=ace.edit("code-view");e.session.setMode("ace/mode/python"),e.setTheme("ace/theme/tomorrow")})},data:{id:"code-dialog"}})});var drawPaneCode=function(){var e=$("#pane-code-view");"1"!=e.attr("_isLoad")&&getSourceCode($("#code"),function(t){e.text(t),(paneCodeEditor=ace.edit("pane-code-view")).setReadOnly(!0),paneCodeEditor.session.setMode("ace/mode/python"),paneCodeEditor.setTheme("ace/theme/tomorrow"),e.attr("_isLoad","1")})};$("#code-tab").click(drawPaneCode);var handleClickModifyAlgorithmCode=function(){"1"===$("#pane-code-view").attr("_isLoad")&&($(".live__algorithm-code-edter-btns_operation").addClass("hidden"),$(".live__algorithm-code-edter-btns_editing").removeClass("hidden"),paneCodeEditor.setReadOnly(!1))},handleClickCancelModifyAlgorithmCode=function(){$(".live__algorithm-code-edter-btns_editing").addClass("hidden"),$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"),paneCodeEditor.setValue(algorithmCode,-1),paneCodeEditor.setReadOnly(!0)},handleClickCompleteModifyAlgorithmCode=function(){$(".live__algorithm-code-edter-btns_editing").addClass("hidden"),$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"),paneCodeEditor.moveCursorTo(-1,-1),paneCodeEditor.setReadOnly(!0);var e=paneCodeEditor.getValue();Cy.ajax("/algorithm/live/changeCode",{data:{backtestId:backtestId,code:e},success:function(t){"00000"==t.code&&(BootstrapDialog.show({title:"提示",message:"修改代码成功!"}),algorithmCode=e,getUpdateCodeHistoryList(1))},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"修改代码失败:"+t.msg})}})},renderPage=function(t,e){var a=$node.find("#pageButton"),i={bootstrapMajorVersion:3,currentPage:t,numberOfPages:10,totalPages:e,itemTexts:function(t,e,a){switch(t){case"first":return"首页";case"prev":return"上一页";case"next":return"下一页";case"last":return"末页";case"page":return e}},onPageClicked:function(t,e,a,i){getUpdateCodeHistoryList(i)}};1<e&&a.bootstrapPaginator(i)},updateBacktestList=function(t,n){Cy.ajax(t,{success:function(t){if("0"!=t.status)return Cy.alert(t.msg),void layer.find(".close").click();for(var e="",a="<option>Python2</option>",i=0;i<t.data.length;i++){if(t.data[i].pyVersion||(t.data[i].pyVersion="2"),t.data[i].uniqueCode==n){var o="selected";t.data[i].pyVersion&&(a="<option>Python"+t.data[i].pyVersion+"</option>")}else o="";e+="<option data-pyVersion='"+t.data[i].pyVersion+"' value='"+t.data[i].backtestId+"' _uniqueCode='"+t.data[i].uniqueCode+"' "+o+">"+t.data[i].name+" - "+(100*t.data[i].overallReturn).toFixed(2)+"%</option>\n"}$(".community-backtest-select-dialog").find("#backtest").html(e),$(".community-backtest-select-dialog").find("#pyVersion").html(a),$(".community-backtest-select-dialog").find("select").selectpicker("refresh")}})},getUpdateCodeHistoryList=function(e){void 0===e&&(e=1);var a=0;Cy.ajax("/algorithm/live/getLiveHistoryList?backtestId="+backtestId+"&page="+e+"&limit=20",{fail:function(t){throw t},error:function(t){throw t},success:function(t){if(403==t.code)return $(".historyCodeList").html("无权限查看");if("00000"!==t.code)return BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg}),!1;t.data.getShowTypeText=function(){return["替换","修改","","新建"][this.showType]||""},totalCount=parseInt(t.data.totalCount),a=Math.ceil(totalCount/20),t.data.showOperation=!window.isShare,$(".historyCodeList").html(Mustache.render('<table class="table"\t\tid="algo_table">\t\t  <thead>\t\t\t<tr>\t\t\t  <td class="align-left">操作时间</td>\t\t\t  <td class="align-left">操作方式</td>\t\t\t  <td class="align-left">备注</td>\t\t\t  <td class="tright">代码</td>\t\t\t</tr>\t\t  </thead>\t\t  <tbody>\t\t\t{{#list}}\t\t\t  <tr class="algorithm_code_modify_list">\t\t\t\t<td class="align-left">\t\t\t\t  {{addTime}}\t\t\t\t</td>\t\t\t\t<td class="align-left">\t\t\t\t  {{{getShowTypeText}}}\t\t\t\t</td>\t\t\t\t<td class="align-left">\t\t\t\t\t<span class="before-empty-null">{{introduce}}</span>\t\t\t\t\t{{#showOperation}}\t\t\t\t\t<span class="change-history-id-remark edit-icon" title="点击备注" data-historyid="{{liveHistoryId}}" data-remark="{{introduce}}"></span>\t\t\t\t\t{{/showOperation}}\t\t\t\t\t</td>\t\t\t\t<td class="tright">\t\t\t\t  <a href="javascript: void(0);"\t\t\t\t\tclass="history-code"\t\t\t\t\thistory-type="{{getCodeType}}"\t\t\t\t\tbacktest-id="{{sourceBacktestId}}"\t\t\t\t\tlive-history-id="{{liveHistoryId}}">\t\t\t\t\t查看当前代码\t\t\t\t  </a>\t\t\t\t  {{#code}}\t\t\t\t\t<input type="hidden" value="{{code}}" />\t\t\t\t  {{/code}}\t\t\t\t</td>\t\t\t  </tr>\t\t\t{{/list}}\t\t  </tbody>\t\t</table>',t.data)),renderPage(e,a),$("#tab-code").attr("_hasDrawn","1")}})},onShowHistoryCodeDialog=function(t){var i=$(this);BootstrapDialog.show({title:"历史策略代码",btnOKLabel:"确认",cssClass:"code-dialog",message:"",onshown:function(t){if("0"===i.attr("history-type")){var e=i.attr("backtest-id");Cy.ajax("/algorithm/backtest/source",{async:!1,data:{backtestId:e},success:function(t){var e=$(".bootstrap-dialog-message").eq(0);if(403==t.code)return e.text("无权限查看");if("00000"!==t.code)BootstrapDialog.alert(t.msg);else{e.attr("id","history-code-view");var a=.7*$("body").height();e.css("height",a+"px"),e.text(t.data.source),$(".code-dialog .modal-dialog").css("width","700px");var i=ace.edit("history-code-view");i.session.setMode("ace/mode/python"),i.setTheme("ace/theme/tomorrow")}}})}else{var a=i.attr("live-history-id");Cy.ajax("/algorithm/live/getLiveHistoryCode",{type:"GET",async:!1,data:{liveHistoryId:a},success:function(t){var e=$(".bootstrap-dialog-message").eq(0);if(403==t.code)return e.text("无权限查看");if("00000"!==t.code)BootstrapDialog.alert(t.msg);else{e.attr("id","history-code-view");var a=.7*$("body").height();e.css("height",a+"px"),e.text(t.data.source),$(".code-dialog .modal-dialog").css("width","700px");var i=ace.edit("history-code-view");i.session.setMode("ace/mode/python"),i.setTheme("ace/theme/tomorrow")}}})}},data:{id:"code-dialog"}})},onBacktestSelect=function(){BootstrapDialog.show({title:"替换代码",cssClass:"community-backtest-select-dialog",message:"",buttons:[{label:"确定",cssClass:"btn-primary",action:function(t){var e=$(".community-backtest-select-dialog").find("#backtest").parent().find('li[class="selected"]');if(0<e.length){var a=e.eq(0).attr("data-original-index"),i=$(".community-backtest-select-dialog").find("#backtest").find("option").eq(a).attr("value");i&&Cy.ajax("/algorithm/live/changeBacktest",{data:"backtestId="+backtestId+"&sourceBacktestId="+i,async:!1,success:function(t){return $("#source-backtest").val(t.data.backtestId),$("#code").attr("_isLoad","0"),getSourceCode($("#code"),function(t){paneCodeEditor.session.setValue(t)}),getUpdateCodeHistoryList(1),BootstrapDialog.show({title:"提示",message:"替换代码成功!"}),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"修改失败:"+t.msg})}})}t.close()}}],onshown:function(t){var e=$(".bootstrap-dialog-message").eq(0);if($("#local_algorithmId").val()<=0)e.html('<p class="mt_20" style="margin-bottom:0">该策略通过金融终端建立，请在提交模拟交易的终端上进行修改。</p>');else{e.html($("#backtest-select-dom").html()),$(".community-backtest-select-dialog").find("select").selectpicker();var a=$("#source-backtest").val();updateBacktestList("/algorithm/backtest/doneList?algorithmId="+algorithmId+"&pyVersion="+pyVersion,a)}}})},handleChangeHistoryIdRemark=function(){var t=$(this),e=t.data("historyid"),a=t.data("remark");BootstrapDialog.confirm({title:"修改备注",message:'<p style="margin-top: 10px"><span>备注：</span><input class="form-control" style="display: inline-block; width: 300px;" autocomplete="off" type="text" id="newHistoryRemark" value="'+a+'"/></p>',callback:function(t){t&&Cy.ajax("/algorithm/live/setHistoryRemark",{data:{liveHistoryId:e,introduce:$("#newHistoryRemark").val()},dataType:"JSON",success:function(t){"00000"===t.code&&(BootstrapDialog.alert("修改成功"),getUpdateCodeHistoryList())}})}})},chart;function updateResultSize(){var t=$("#backtest-atomic-container").width()-$("#result-area").width()-62;$("body").hasClass("mobile")||$("#splitter-pane").width(t)}function cancel(){Cy.ajax("/algorithm/index/cancel",{data:"backtestId="+backtestId,async:!1,success:function(t){return stopCycle=!0,$("#detail-finished").html("已取消"),$("#done-backtest-pane").removeClass("hidden"),$("#inprogress-backtest-pane").addClass("hidden"),$.each($(".enable-when-done"),function(t,e){$(e).css("color","#7d8386"),$(e).css("cursor","pointer")}),fetchBacktestRunTime(backtestId,function(t){$("#backtest-complete").html(Mustache.render('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 已取消{{#untilNowSec}}，实际耗时{{untilNowSec}}{{/untilNowSec}}{{#amount}}，积分{{amount}}{{/amount}}',{untilNowSec:t.untilNowSec,amount:t.creditsLog.amount}))}),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法取消:"+t.msg})}})}$node.delegate(".live__algorithm-code-edter-modify-btn","click",handleClickModifyAlgorithmCode),$node.delegate(".live__algorithm-code-edter-replace-btn","click",onBacktestSelect),$node.delegate(".live__algorithm-code-modify-cancel-btn","click",handleClickCancelModifyAlgorithmCode),$node.delegate(".live__algorithm-code-modify-complete-btn","click",handleClickCompleteModifyAlgorithmCode),$node.delegate(".change-history-id-remark","click",handleChangeHistoryIdRemark),$node.delegate(".history-code","click",onShowHistoryCodeDialog),$(".live__algorithm-code-replace-popover").popover({placement:"right",trigger:"hover",html:!0,content:"替换代码立即生效；g和context的变量不受影响；initialize不会再次执行，请使用 after_code_changed修改"}),$("#view-detail-button").click(function(){BootstrapDialog.show({title:"回测详情",btnOKLabel:"确认",message:$("#backtest-detail").html().replace(/(\n)+|(\r\n)+/g,"")})}),$("#export-chart-button").click(function(){chart&&chart.exportChart()}),$("#export-csv-button").click(function(){chart&&(window.location.href=backtestAPI.export+"?backtestId="+backtestId+"&type=result")}),$("#download-code-button").click(function(){$.ajax({url:"/algorithm/backtest/downloadZip?backtest_id="+backtestId,type:"GET",dataType:"json",success:function(t){"00000"===t.code?t.data&&0!==t.data.length?$.each(t.data,function(t,e){window.open(e)}):BootstrapDialog.alert("暂无压缩包数据可下载"):BootstrapDialog.alert(t.msg)}})}),$(".popover-right").popover({placement:"bottom",trigger:"manual",html:!0,content:'风险指标有利于您对策略进行客观的评价，<a target="_blank" style="color:#337ab7;font-weight:normal" href="/api#%E9%A3%8E%E9%99%A9%E6%8C%87%E6%A0%87">查看计算公式</a>'}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)}),updateResultSize(),$(window).resize(function(){updateResultSize()}),$("#result-tabs  a").click(function(){var t;if($(this).hasClass("enable-when-done")&&!doneFlag)return!1;"tab-summaryinfo"===$(".dailybars-output > .active").attr("id")?$(".dailybars-output > .active").addClass("hidden-1"):$(".dailybars-output > .active").addClass("hidden"),"#tab-summaryinfo"===(t=$(this).attr("href").toString())?$(t).removeClass("hidden-1"):($("#tab-summaryinfo").addClass("hidden-1"),$(t).removeClass("hidden")),"#tab-transactioninfo"==t&&0==$(t).attr("_hasDrawn")?fillTransaction():"#tab-positioninfo"==t&&0==$(t).attr("_hasDrawn")?fillPosition():$(this).hasClass("risk")&&0==$(t).attr("_hasDrawn")?fillRisk():"#tab-logs"==t&&0==$(t).attr("_hasDrawn")?(fillLog(),fillErrorLog()):"#tab-profile"==t&&0==$(t).attr("_hasDrawn")?fillProfile():"#tab-code"==t&&0==$(t).attr("_hasDrawn")&&getUpdateCodeHistoryList(1)}),$("#cancel-backtest-button").click(function(){return BootstrapDialog.confirm({title:"提示",btnCancelLabel:"取消",btnOKLabel:"确认",message:"确实要取消?",callback:function(t){t&&cancel()}}),!1});var resultOffset=0,userRecordOffset=0,logOffset=0,errorLogOffset=0,frequency=$("#frequency").attr("value"),stopCycle=!1,stopResult=!1,backtestId=$("#backtestId").val(),dataResult=[],dataBenchmark=[],excessResult=[],dataGains={earn:[],lose:[]},dataOrders={buy:[],sell:[]},origDataOffset=0,userRecord=null,startDate=$("#startDate").html(),endDate=$("#endDate").html(),minY=0,chartType="line";Highcharts.setOptions({global:{timezoneOffset:-480},lang:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdays:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],rangeSelectorZoom:"缩放：",rangeSelectorFrom:"时间：",rangeSelectorTo:"-"}});var timeoutSpan=3e3;function cycleCheck(){stopCycle||(0==stopResult&&drawResult(backtestId),setTimeout(cycleCheck,timeoutSpan))}function toFixed(t,e,a){return String(isNil(t)?t:Number(t).toFixed(e)+(a||""))}function isNil(t){return null==t}function fillStatsExtraHtml(t){$("#win_ratio").html(toFixed(t.data.win_ratio,3)),$("#day_win_ratio").html(toFixed(t.data.day_win_ratio,3)),$("#profit_loss_ratio").html(toFixed(t.data.profit_loss_ratio,3)),$("#win_count").html(String(t.data.win_count)),$("#lose_count").html(String(t.data.lose_count))}function fillStatsExtra(){$("#backtest-decryptId").val()<175e4||Cy.ajax(backtestAPI.stats+"?backtestId="+backtestId,{success:function(t){403!=t.code&&(t.data?void 0!==t.data.win_ratio?fillStatsExtraHtml(t):setTimeout(fillStatsExtra,2e3):setTimeout(fillStatsExtra,500))}})}function fillStats(){Cy.ajax(backtestAPI.stats+"?backtestId="+backtestId,{success:function(t){if(403!=t.code)if(t.data){var e=startDate.substring(0,4),a=startDate.substring(5,7)-1,i=startDate.substring(8,10),o=(new Date(e,a,i,0,0,0).getTime(),""),n="",s="",r="";if(e=endDate.substring(0,4),a=endDate.substring(5,7)-1,i=endDate.substring(8,10),t.data.annual_algo_return)l=t.data.annual_algo_return;else{e=t.data.trading_days/250;var l=Math.pow(1+t.data.algorithm_return,1/e)-1}0<l?n="red":l<0&&(n="green"),0<t.data.algorithm_return?o="red":t.data.algorithm_return<0&&(o="green"),0<t.data.benchmark_return?s="red":t.data.benchmark_return<0&&(s="green"),0<t.data.excess_return?r="red":t.data.excess_return<0&&(r="green"),$("#year_returns").html(String(isNil(l)?l:(100*l).toFixed(2)+"%")),l&&$("#year_returns").addClass(n),$("#total_returns").html(String(isNil(t.data.algorithm_return)?t.data.algorithm_return:(100*t.data.algorithm_return).toFixed(2)+"%")),t.data.algorithm_return&&$("#total_returns").addClass(o),$("#benchmark_returns").html(String(isNil(t.data.benchmark_return)?t.data.benchmark_return:(100*t.data.benchmark_return).toFixed(2)+"%")),t.data.benchmark_return&&$("#benchmark_returns").addClass(s),$("#excess_return").html(String(isNil(t.data.excess_return)?t.data.excess_return:(100*t.data.excess_return).toFixed(2)+"%")),t.data.excess_return&&$("#excess_return").addClass(r),$("#alpha").html(toFixed(t.data.alpha,3)),$("#beta").html(toFixed(t.data.beta,3)),$("#sharpe").html(toFixed(t.data.sharpe,3)),$("#sortino").html(toFixed(t.data.sortino,3)),$("#information").html(toFixed(t.data.information,3)),$("#algorithm_volatility").html(toFixed(t.data.algorithm_volatility,3)),$("#benchmark_volatility").html(toFixed(t.data.benchmark_volatility,3)),$("#excess_return_max_drawdown").html(String(t.data.excess_return_max_drawdown)),$("#avg_excess_return").html(String(t.data.avg_excess_return)),$("#excess_return_sharpe").html(String(t.data.excess_return_sharpe)),void 0===t.data.win_ratio?fillStatsExtra():fillStatsExtraHtml(t);var d=(100*t.data.max_drawdown).toFixed(2)+"%",c=t.data.max_drawdown_period;if(c){var u=(c=c.map(function(t,e){return 0<=t.indexOf("-")&&(t=t.split("-").join("/")),t}))[0]+","+c[1];chart.addSeries({type:"flags",data:[{x:Date.parse(new Date(c[0]+" 16:00:00")),title:" ",text:"最大回撤"},{x:Date.parse(new Date(c[1]+" 16:00:00")),title:" ",text:"最大回撤"}],onSeries:"returnSeries",fillColor:"#00BB00",states:{hover:{fillColor:"#00BB00"}},shape:"circlepin",y:-3,height:4,width:4})}$("#max_drawdown").html(d),$("#max_drawdown_period").html(u),$("#run-time-cost").html(Mustache.render("{{#untilNowSec}}，实际耗时{{untilNowSec}}{{/untilNowSec}}{{#amount}}，积分{{amount}}{{/amount}}",creditsLog))}else setTimeout(fillStats,500)}})}var isBacktestLogMax=!1;function fillLog(){Cy.ajax(backtestAPI.log+"?backtestId="+backtestId+"&offset="+logOffset,{fail:function(t){},success:function(t){if(403==t.code)return $("#log").find("pre").eq(0).html("无权限查看");if($("#logs-init").addClass("hidden"),isBacktestLogMax=t.data.max,0==logOffset&&$("#log").find("pre").empty(),isBacktestLogMax?$("#logsMoreDownload").show():$("#logsMoreDownload").hide(),(0!=t.data.logArr.length||2!=t.data.state&&3!=t.data.state)&&!(t.data.offset<logOffset)){for(var e="",a=0;a<t.data.logArr.length;a++)if(t.data.logArr[a]){var i=t.data.logArr[a].split(" - ");if(2<i.length){var o='<span class="log-date">'+i[0]+"</span> - ";if("ERROR"==i[1])var n="log-error";else if("WARNING"==i[1])n="log-warning";else n="log-info";var s='<span class="'+n+'">'+i[1]+"</span> - ";i.shift(),i.shift();var r=o+s+i.join("-")}else r=t.data.logArr[a];e=e+"<p>"+r.replace(/\n/g,"<br/>"),logOffset++}$("#log").find("pre").eq(0).append(e)}}})}function fillErrorLog(){Cy.ajax(backtestAPI.errLog+"?backtestId="+backtestId,{success:function(t){for(var e=$("#logInfo"),a=$(".logs-switch"),i=$("#error-log").show().find("pre").eq(0),o="",n=0;n<t.data.logArr.length;n++)o=o+"<p>"+t.data.logArr[n].replace(/\n/g,"<br/>"),errorLogOffset++;o&&(e.hide(),a.find(".active").removeClass("active"),a.find('span[data-target="error-log"]').addClass("active"),0<i.length?i.append(o):$("#log").find("pre").eq(0).append(o))}})}function fillProfile(){Cy.ajax("/algorithm/backtest/profile?backtestId="+backtestId,{success:function(t){if(t.data.profile&&0<t.data.profile.length)$("#profile").find("pre").eq(0).append(t.data.profile);else{$("#profile").find("pre").eq(0).append("暂无相关内容，请确认在代码最开始使用enable_profile()打开性能分析。请在API中查看enable_profile()使用方法")}$("#tab-profile").attr("_hasDrawn",1)}})}function fail(){failFlag=!0,$("#done-backtest-pane").removeClass("hidden"),$("#backtest-complete").html(Mustache.render('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 回测失败{{#untilNowSec}}，实际耗时{{untilNowSec}}{{/untilNowSec}}{{#amount}}，积分{{amount}}{{/amount}}',creditsLog)),$("#inprogress-backtest-pane").addClass("hidden"),enableShare(),doneFlag=!0,$.each($(".enable-when-done"),function(t,e){$(e).css("color","#7d8386"),$(e).css("cursor","pointer")})}$("#log").scroll(function(){$(this)[0].scrollHeight<=$(this)[0].scrollTop+550&&fillLog()}),$("#logsMoreDownload>span").click(function(){handleAddExportZip(backtestId,"log",handleAddExportZipSuccess)}),$("body").delegate(".logs-switch span","click",function(){var t=$(this).data("target");$(".logs-switch").find(".active").removeClass("active"),$(".logs-switch").find('span[data-target="'+t+'"]').addClass("active"),$(".logs-container-warp").hide(),$("#"+t).show()});var dataResultLog=[],dataBenchmarkLog=[],excessResultLog=[],dataResultBak=[],dataBenchmarkBak=[],excessResultBak=[];function changeToLogarithm(){if("log"===chartType)return!1;onGetResetDataFlag=!0,offset=100,chartType="log";for(var t=0;t<dataResult.length;t++)dataResultLog[t]={},dataResultLog[t].x=dataResult[t].x,dataResultLog[t].y=dataResult[t].y+offset,dataBenchmarkLog[t]={},dataBenchmarkLog[t].x=dataBenchmark[t].x,dataBenchmarkLog[t].y=dataBenchmark[t].y+offset,excessResultLog[t]={},excessResultLog[t].x=excessResult[t].x,excessResultLog[t].y=dataResultLog[t].y/dataBenchmarkLog[t].y*100;chart.yAxis[0].update({type:"logarithmic",labels:{formatter:function(){return(this.value-offset).toFixed(2)+"%"}}},!1);for(t=0;t<3;t++)chart.series[t].update({threshold:offset,tooltip:{pointFormatter:function(){return pointFormat='<span style="color:{point.color}">●</span> {series.name}: <b>'+(this.y-offset).toFixed(2)+"%</b><br/>",Highcharts.format(pointFormat,{point:this,series:this.series})}}},!1);isInit?draw(dataResultLog,dataBenchmarkLog,excessResultLog,userRecord,dataGains,dataOrders):redrawChart()}function changeToLine(){if("line"===chartType)return!1;chartType="line",onGetResetDataFlag=!0,chart.yAxis[0].update({type:"line",labels:{formatter:function(){return this.value.toFixed(2)+"%"}}},!1);for(var t=0;t<3;t++)chart.series[t].update({threshold:0,tooltip:{pointFormatter:function(){return pointFormat='<span style="color:{point.color}">●</span> {series.name}: <b>'+this.y.toFixed(2)+"%</b><br/>",Highcharts.format(pointFormat,{point:this,series:this.series})}}},!1);isInit?draw(dataResultBak,dataBenchmarkBak,excessResultBak,userRecord,dataGains,dataOrders):redrawChart()}$(".chart-type").click(function(){"log"===$(this).val()?changeToLogarithm():changeToLine()}),$("#exceedReturn").click(function(){var t,e,a=$(this).is(":checked");flag||(addExcessMaxDrawdownTag(calculateMaxDrawdown(excessResult)),flag=!0),t=chart.series[chart.series.length-1],e=chart.series[2],a?(e.show(),t.show()):(e.hide(),t.hide())});var creditsLog={};function drawResult(t){stopResult=!0,fetchBacktestRunTime(t,function(t){(creditsLog=t.creditsLog).untilNowSec=t.untilNowSec}),Cy.ajax(backtestAPI.result+"?backtestId="+t+"&offset="+resultOffset+"&userRecordOffset="+userRecordOffset,{timeout:5e3,fail:function(t){stopResult=!1},error:function(t){stopResult=!1},success:function(t){if(403==t.code)return $("#backtest-chart-outer-container").html("无权限查看");if(0!=t.data.state){var e=t.data.result.benchmark,a=t.data.result.overallReturn,i=t.data.result.gains,o=t.data.result.orders,n=t.data.result.count,s=parseInt(t.data.result.offset);if(!(n<=0&&2!=t.data.state&&(3==t.data.state||(stopResult=!1),0===t.data.state))){if(chart||(chart=newChart(t.data.userRecord),clearHighchartLable()),t.data.userRecord){if(!userRecord)for(var r in userRecord={},t.data.userRecord)userRecord[r]=getRemainNullData();for(var r in t.data.userRecord)void 0===userRecord[r]&&(userRecord[r]=getRemainNullData(),chart.addSeries({name:r,data:userRecord[r],dataGrouping:grouping_options,yAxis:1},!1))}for(var l={},d=null,c=0;c<n;c++)dataResult[c+s]&&(dataResult[c+s].x=a.time[c],dataResult[c+s].y=a.value[c],excessResult[c+s].x=a.time[c],excessResult[c+s].y=(a.value[c]+100)/(e.value[c]+100)*100-100,dataBenchmark[c+s].x=e.time[c],dataBenchmark[c+s].y=e.value[c],d=dataResult[c+s].y<excessResult[c+s].y?dataResult[c+s].y:excessResult[c+s].y,dataBenchmark[c+s].y<d&&(d=dataBenchmark[c+s].y),d<minY&&(minY=d),dataGains.earn[c+s].x=i.earn.time[c],dataGains.earn[c+s].y=i.earn.value[c],dataGains.lose[c+s].x=i.lose.time[c],dataGains.lose[c+s].y=i.lose.value[c],dataOrders.buy[c+s].x=o.buy.time[c],dataOrders.buy[c+s].y=o.buy.value[c],dataOrders.sell[c+s].x=o.sell.time[c],dataOrders.sell[c+s].y=o.sell.value[c],l[a.time[c]]=c+s);if(t.data.userRecord){var u=1e5;for(var r in t.data.userRecord){var h=0;for(c=0;c<t.data.userRecord[r].time.length;c++)if(t.data.userRecord[r].time[c]){var p=86400*parseInt(t.data.userRecord[r].time[c]/1e3/86400)*1e3-288e5,g=timeBar[p];userRecord[r][g]||(userRecord[r][g]={}),userRecord[r][g].x=t.data.userRecord[r].time[c],userRecord[r][g].y=t.data.userRecord[r].value[c],h++}u=Math.min(u,h)}userRecordOffset+=u}if(resultOffset=s+n,0<dataResult.length&&0<resultOffset&&dataResult.length>=resultOffset){var f=dataResult[resultOffset-1].x;for(c=resultOffset;c<dataResult.length&&dataResult[c].x<f;c++)dataResult[c].x=f,excessResult[c].x=f,dataBenchmark[c].x=f,dataGains.earn[c].x=f,dataGains.lose[c].x=f,dataOrders.buy[c].x=f,dataOrders.sell[c].x=f}for(c=0;c<dataResult.length;c++)dataResultBak[c]={},dataResultBak[c].x=dataResult[c].x,dataResultBak[c].y=dataResult[c].y,dataBenchmarkBak[c]={},dataBenchmarkBak[c].x=dataBenchmark[c].x,dataBenchmarkBak[c].y=dataBenchmark[c].y,excessResultBak[c]={},excessResultBak[c].x=excessResult[c].x,excessResultBak[c].y=excessResult[c].y;if(draw(dataResult,dataBenchmark,excessResult,userRecord,dataGains,dataOrders),3==t.data.state)return fail(),void(n<=0&&(stopResult=doneFlag=!0));if(4==t.data.state)return failFlag=!0,$("#done-backtest-pane").removeClass("hidden"),$("#backtest-complete").html(Mustache.render('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 已取消{{#untilNowSec}}，实际耗时{{untilNowSec}}{{/untilNowSec}}{{#amount}}，积分{{amount}}{{/amount}}',creditsLog)),$("#inprogress-backtest-pane").addClass("hidden"),$.each($(".enable-when-done"),function(t,e){$(e).css("color","#7d8386"),$(e).css("cursor","pointer")}),void(doneFlag=stopResult=!0);if((2==t.data.state||3==t.data.state)&&0==n)return stopCycle=!0,$("#detail-finished").html("完成"),setRangeAllIndex(2),$("#done-backtest-pane").removeClass("hidden"),$("#inprogress-backtest-pane").addClass("hidden"),$("#btn-attributionAnaly").removeClass("disabled"),fillStats(),stopResult=doneFlag=!0,$.each($(".enable-when-done"),function(t,e){$(e).css("color","#7d8386"),$(e).css("cursor","pointer")}),enableLiveTrade(),enableShare(),isTanChuang(),$(".chart-type").removeAttr("disabled"),initDataResult=deepCopy(dataResult),void(initDataBenchmark=deepCopy(dataBenchmark));var m=Math.min(100,resultOffset/dataResult.length*100).toFixed(1);80<m&&(timeoutSpan=1e3),$("#backtest-progress-bar").width(m+"%"),stopResult=!1}}else stopResult=!1}})}Date.prototype.Format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var a in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[a]:("00"+e[a]).substr((""+e[a]).length)));return t};var g_tradeDays=null,timeBar={};function getRemainNullData(){for(var t=[],e=0;e<g_tradeDays.length;e++)tick=1e3*g_tradeDays[e],t.push({x:tick,y:null}),timeBar[tick]=e;return t}function initChartData(){dataResult=getRemainNullData(),excessResult=getRemainNullData(),dataBenchmark=getRemainNullData(),dataOrders.buy=getRemainNullData(),dataOrders.sell=getRemainNullData(),dataGains.earn=getRemainNullData(),dataGains.lose=getRemainNullData(),errorLogOffset=logOffset=userRecordOffset=resultOffset=origDataOffset=0,chart&&(chart.destroy(),chart=userRecord=null)}function initChart(e){Cy.ajax("/algorithm/backtest/tradeDays?startDay="+startDate+"&endDay="+endDate,{success:function(t){t.data&&(g_tradeDays=t.data),initChartData(),e()},fail:function(t){initChartData(),e()}})}function draw(t,e,a,i,o,n){var s=3;if(chart.series[0].setData(t,!1),chart.series[1].setData(e,!1),chart.series[2].setData([].concat(a),!1),i)for(var r in i)chart.series[s]&&chart.series[s].setData(i[r],!1),s++;chart.series[s++].setData(o.earn,!1),chart.series[s++].setData(o.lose,!1),chart.series[s++].setData(n.buy,!1),chart.series[s].setData(n.sell,!1),chart.redraw()}function clearHighchartLable(){$("text[text-anchor=end]").each(function(){"Highcharts.com"==this.innerHTML&&$(this).remove()})}var hasDrawLeftLine=!1;function drawLeftLine(){hasDrawLeftLine||($("path[stroke=lightgray]").each(function(t){var e=$(this).attr("d").split(" ");if(parseFloat(e[1])<100){for(var a=1;a<e.length;a+=3)e[a]=10;posNew=e.join(" ");var i=$(this).clone();$(i).attr("d",posNew),$(this.parentNode).append(i)}}),hasDrawLeftLine=!0)}var grouping_options=null;function newChart(t){var e=[{type:"area",name:"策略收益",color:"#4572A7",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,id:"returnSeries",data:[]},{name:"基准收益",color:"#aa4643",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]},{name:"超额收益",visible:!(grouping_options={enabled:!0,approximation:"average",units:[["week",[1]],["month",[1,2,3,4,6]]],groupPixelWidth:1}),id:"excessSeries",color:"#FFA042",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]}],a=null,i=null;if(t){var o=1;for(var n in a=16,i=60,t)e.push({name:n,data:[],dataGrouping:grouping_options,yAxis:1});var s=[{height:"36%",lineWidth:2,title:{text:"收益"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}},{labels:{align:"right",x:-3},title:{text:"自定义数据"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],top:"40%",height:"20%",offset:0,lineWidth:2}]}else{o=0;a=26,i=40;s=[{height:"36%",lineWidth:2,title:{text:"收益"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}}]}return s.push({title:{text:"每日盈亏"},plotLines:[{value:0,color:"black",width:2}],top:i+4+"%",height:a+"%",offset:0,lineWidth:2}),s.push({title:{text:"每日买卖"},plotLines:[{value:0,color:"black",width:2}],top:i+a+8+"%",height:a+"%",offset:0,lineWidth:2}),e.push({type:"column",name:"当日盈利",data:[],dataGrouping:grouping_options,yAxis:o+1}),e.push({type:"column",name:"当日亏损",data:[],dataGrouping:grouping_options,tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},pointFormatter:function(t){return t='<span style="color:{point.color}">●</span> {series.name}: <b>'+Math.abs(this.y)+"</b><br/>",Highcharts.format(t,{point:this,series:this.series})}},yAxis:o+1}),e.push({type:"column",name:"当日开仓",data:[],dataGrouping:grouping_options,yAxis:o+2}),e.push({type:"column",name:"当日平仓",data:[],dataGrouping:grouping_options,tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},pointFormatter:function(t){return t='<span style="color:{point.color}">●</span> {series.name}: <b>'+Math.abs(this.y)+"</b><br/>",Highcharts.format(t,{point:this,series:this.series})}},yAxis:o+2}),chart=new Highcharts.StockChart({chart:{renderTo:"backtest-chart-outer-container",events:{tooltipRefresh:function(t){chartHoverPointIndex=chart.hoverPoints[0].index}},animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],title:{text:""},rangeSelector:{buttons:[{type:"month",count:1,text:"1个月"},{type:"month",count:12,text:"1年"},{type:"all",text:"全部"}],inputEnabled:!0,inputDateFormat:"%Y-%m-%d",inputPosition:{x:-10},selected:2},plotOptions:{series:{turboThreshold:0,connectNulls:!0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},legend:{enabled:!1,align:"center",verticalAlign:"top",y:55,borderWidth:0},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:120,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}},allowDecimals:!1,events:{setExtremes:function(t){isInitFlag||"rangeSelectorButton"!==t.trigger?onGetResetDataFlag&&("rangeSelectorButton"==t.trigger||"navigator"===t.trigger&&("mouseup"===t.DOMEvent.type||"touchend"===t.DOMEvent.type)?onGetResetData(t):"rangeSelectorInput"===t.trigger&&onGetResetData(t)):isInitFlag=!0}}},yAxis:s,series:e})}var chartHoverPointIndex=0;document.onkeydown=function(t){var e,a=chart;switch(a&&(e=a.series[0].points.length),t.keyCode){case 37:0==chartHoverPointIndex?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex-=1;for(var i=[],o=0;o<a.series.length;o++)i[o]=a.series[o].points[chartHoverPointIndex];a.tooltip.refresh(i);break;case 39:chartHoverPointIndex==e?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex+=1;for(i=[],o=0;o<a.series.length;o++)i[o]=a.series[o].points[chartHoverPointIndex];a.tooltip.refresh(i)}};var transactionTdWidth=null,transactionDisplayCols=["amount","transaction","type","price","total","gains","commission"];function drawTransactioninfo(t){var e=["日期","委托时间","品种","标的","交易类型","下单类型","成交数量","成交价","成交额","委托数量","委托价格","状态","平仓盈亏","手续费","最后更新时间"],a=[{name:"date",index:"date",align:"center",sorttype:"date",formatter:"date"},{name:"time",index:"time",align:"center"},{name:"security",index:"security",align:"center"},{name:"stock",index:"stock",align:"center",width:300},{name:"transaction",index:"transaction",align:"center",sorttype:!1},{name:"type",index:"type",align:"center",sorttype:!1},{name:"amount",index:"amount",align:"center",sorttype:"float"},{name:"price",index:"price",align:"center",sorttype:"float"},{name:"total",index:"total",align:"center",sorttype:"float",formatter:"number",width:180},{name:"orderAmount",index:"orderAmount",align:"center",sorttype:"float"},{name:"limitPrice",index:"limitPrice",align:"center",sorttype:"float"},{name:"status",index:"status",align:"center",sorttype:"float"},{name:"gains",index:"gains",align:"center",sorttype:"float",formatter:"number"},{name:"commission",index:"commission",align:"center",sorttype:"float",formatter:"number"},{name:"matchTime",index:"matchTime",align:"center",sorttype:"date",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i:s",newformat:"Y-m-d H:i:s"}}],i={date:1,time:1,stock:1},o={type:1,gains:1,orderAmount:1,limitPrice:1,commission:1},n=$.cookie("default_transaction_cols");n&&0<n.length&&(transactionDisplayCols=n.split(","));for(var s={},r=0;r<transactionDisplayCols.length;r++)s[transactionDisplayCols[r]]=1;for(r=0;r<a.length;r++)s[a[r].index]||i[a[r].index]||(a[r].hidden=!0);var l={autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:570,rowNum:1e4,colNames:e,colModel:a,viewrecords:!0,hidegrid:!1,altRows:!0,grouping:!0,groupingView:{groupField:["date","time"],groupSummary:[!0,!1],groupColumnShow:[!0,!0],groupText:[!1,!1],groupCollapse:!1,groupOrder:["asc","asc"]},caption:null};6<transactionDisplayCols.length&&(l.shrinkToFit=!1,l.autoScroll=!0);$("#table-transactioninfo").jqGrid(l);transactionTdWidth=$("#table-transactioninfo").getGridParam("width");var d,c="",u=$(".title_item.actives").attr("role");for(r=0;r<e.length;r++)i[a[r].index]||"conclude_trans"==u&&o[a[r].index]||(c=c+' <div class="checkbox"><label><span class="check_label '+(d=s[a[r].index]?"checked":"")+'"><input type="checkbox" name="transaction-select" value="'+a[r].index+'" '+d+"></span>"+e[r]+"</label></div>");return $("#transaction-column-select").html(c),$("#table-transactioninfo")}$("#transaction-column-select").delegate("input","click",function(){var t=$(this).val();if(this.checked){$("#table-transactioninfo").jqGrid("showCol",t),transactionDisplayCols.push(t);var e=transactionDisplayCols.join(",");$.cookie("default_transaction_cols",e),$(this).parent().addClass("checked");for(var a=$("#table-transactioninfo").jqGrid("getGridParam","colModel"),i=0,o=0;o<a.length;o++)!1===a[o].hidden&&i++;6<i&&$("#table-transactioninfo").jqGrid("setGridParam",{shrinkToFit:!1,autoScroll:!0})}else{$("#table-transactioninfo").jqGrid("hideCol",t);for(var n=null,s=0;s<transactionDisplayCols.length;s++)if(transactionDisplayCols[s]==t){n=s;break}n&&transactionDisplayCols.splice(n,1);e=transactionDisplayCols.join(",");$.cookie("default_transaction_cols",e),$(this).parent().removeClass("checked");for(a=$("#table-transactioninfo").jqGrid("getGridParam","colModel"),i=0,o=0;o<a.length;o++)!1===a[o].hidden&&i++;i<=6&&$("#table-transactioninfo").jqGrid("setGridParam",{shrinkToFit:!0,autoScroll:!1})}$("#table-transactioninfo").setGridWidth(transactionTdWidth)});var positionTdWidth=null,positionDisplayCols=["amount","price","position","gain","value"];function drawPositioninfo(t){var e=["日期","品种","标的","多空","数量","可用数量","收盘价/结算价","市值/价值","盈亏/逐笔浮盈","开仓均价","持仓均价(期货)","保证金","当日盈亏","今手数","仓位占比","盈亏占比"],a=[{name:"date",index:"date",align:"center",sorttype:"date",formatter:"date",resizable:!1},{name:"security",index:"security",align:"center",resizable:!1},{name:"stock",index:"stock",align:"center",sorttype:function(t,e){return'<span class="label label-cash">Cash</span>'==t?"*"+t:t},resizable:!1},{name:"side",index:"side",align:"center",resizable:!1},{name:"amount",index:"amount",align:"center",sorttype:"float",resizable:!1},{name:"closeableAmount",index:"closeableAmount",align:"center",sorttype:"float"},{name:"price",index:"price",align:"center",sorttype:"float",resizable:!1},{name:"value",index:"value",align:"center",sorttype:"int",formatter:"number",width:180,summaryType:"sum",summaryTpl:"<b>总共:{0}</b>",resizable:!1},{name:"gain",index:"gain",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"avgCost",index:"avgCost",align:"center",sorttype:"float",resizable:!1},{name:"holdCost",index:"holdCost",align:"center",sorttype:"float",resizable:!1},{name:"margin",index:"margin",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"dailyGains",index:"dailyGains",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"todayAmount",index:"todayAmount",align:"center",sorttype:"float",resizable:!1},{name:"positionPersent",index:"positionPersent",align:"center",sorttype:"float",resizable:!1,formatter:function(t,e,a){return t=t?parseFloat(t.split("%")[0]).toFixed(2)+"%":""}},{name:"gainPercentStr",index:"gainPercentStr",align:"center",sorttype:"float",resizable:!1}],i={date:1,time:1,stock:1},o=$.cookie("default_position_cols");o&&0<o.length&&(positionDisplayCols=o.split(","));for(var n={},s=0;s<positionDisplayCols.length;s++)n[positionDisplayCols[s]]=1;for(s=0;s<a.length;s++)n[a[s].index]||i[a[s].index]||(a[s].hidden=!0);var r={autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:570,rowNum:1e4,colNames:e,colModel:a,viewrecords:!0,hidegrid:!1,altRows:!0,grouping:!0,groupingView:{groupField:["date"],groupSummary:[!0],groupColumnShow:[!1],groupText:["<b>{0}</b>"],groupCollapse:!1,groupOrder:["asc"]},caption:null};7<positionDisplayCols.length&&(r.shrinkToFit=!1,r.autoScroll=!0),$("#table-positioninfo").jqGrid(r),positionTdWidth=$("#table-positioninfo").getGridParam("width");var l="",d="";for(s=0;s<e.length;s++)i[a[s].index]||(l=l+' <div class="checkbox"><label><span class="check_label '+(d=n[a[s].index]?"checked":"")+'"><input type="checkbox" name="position-select" value="'+a[s].index+'" '+d+"></span>"+e[s]+"</label></div>");return $("#position-column-select").html(l),$("#table-positioninfo")}function drawRisk(t,e,a){if(!(e.length<=0)){var i=[{name:"date",index:"date",width:196,align:"center"}];for(var o in e[0])"date"!=o&&i.push({name:o,index:o,width:175,align:"center",formatter:"currency",formatoptions:{decimalPlaces:4},sorttype:"float"});$("#"+t).jqGrid({data:e,datatype:"local",height:570,rowNum:1e4,colNames:a,colModel:i,viewrecords:!0,hidegrid:!1,altRows:!0})}}function drawBenchmarkPeriodReturn(t){drawRisk("table-benchmark_period_return",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlgorithmPeriodReturn(t){drawRisk("table-algorithm_period_return",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlpha(t){drawRisk("table-alpha",t,["日期","1个月","3个月","6个月","12个月"])}function drawBeta(t){drawRisk("table-beta",t,["日期","1个月","3个月","6个月","12个月"])}function drawSharp(t){drawRisk("table-sharpe",t,["日期","1个月","3个月","6个月","12个月"])}function drawSortino(t){drawRisk("table-sortino",t,["日期","1个月","3个月","6个月","12个月"])}function drawInformation(t){drawRisk("table-information",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlgovolatility(t){drawRisk("table-algo_volatility",t,["日期","1个月","3个月","6个月","12个月"])}function drawBenchmarkvolatility(t){drawRisk("table-benchmark_volatility",t,["日期","1个月","3个月","6个月","12个月"])}function drawMaxdrawdown(t){drawRisk("table-max_drawdown",t,["日期","1个月","3个月","6个月","12个月"])}function initTransaction(){addTransaction(),$("#table-transactioninfo").height()<$(".transaction-info-pane").eq(0).height()&&setTimeout(initTransaction,5e3)}$("#position-column-select").delegate("input","click",function(){var t=$(this).val();if(this.checked){$("#table-positioninfo").jqGrid("showCol",t),positionDisplayCols.push(t);var e=positionDisplayCols.join(",");$.cookie("default_position_cols",e),$(this).parent().addClass("checked");for(var a=$("#table-positioninfo").jqGrid("getGridParam","colModel"),i=0,o=0;o<a.length;o++)!1===a[o].hidden&&i++;7<i&&$("#table-positioninfo").jqGrid("setGridParam",{shrinkToFit:!1,autoScroll:!0})}else{$("#table-positioninfo").jqGrid("hideCol",t);for(var n=null,s=0;s<positionDisplayCols.length;s++)if(positionDisplayCols[s]==t){n=s;break}n&&positionDisplayCols.splice(n,1);e=positionDisplayCols.join(",");$.cookie("default_position_cols",e),$(this).parent().removeClass("checked");for(a=$("#table-positioninfo").jqGrid("getGridParam","colModel"),i=0,o=0;o<a.length;o++)!1===a[o].hidden&&i++;i<=7&&$("#table-positioninfo").jqGrid("setGridParam",{shrinkToFit:!0,autoScroll:!1})}$("#table-positioninfo").setGridWidth(positionTdWidth)});var transactionDateOffset=startDate;function fillTransaction(){$("#tab-transactioninfo").attr("_hasDrawn",1),Cy.ajax(backtestAPI.transactionInfo+"?backtestId="+backtestId,{success:function(t){var e=$("#table-transactioninfo");if(403==t.code&&e.html("<tr><td>无权限查看</td></tr>"),"0"!==t.data.status){for(var a=new Array,i=0;i<t.data.transaction.length;i++){var o=t.data.transaction[i];"string"==typeof o.total&&-1<o.total.indexOf("(")&&(o.total=o.total.match(/\((.+)\)/)[1]),a.push(o),transactionDateOffset=o.tradeDate?o.tradeDate:o.date}if(0===a.length&&e.hasClass("is-exceed"))return e.empty();var n=drawTransactioninfo(a);if(transactionOffset=t.data.transaction.length,bindGroupEvent(n),t.data.max){var s='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="transaction"                        backtestId="'+backtestId+'"                    >导出交易详情</span>                </div>';e.after(s)}else $("#tab-transactioninfo").find(".ui-jqgrid-bdiv").scroll(function(){nScrollHight=$(this)[0].scrollHeight,nScrollTop=$(this)[0].scrollTop,nScrollTop+570>=nScrollHight&&addTransaction(nScrollTop)}),1==t.data.status&&initTransaction()}else setTimeout(fillTransaction,3e3)},fail:function(){$("#tab-transactioninfo").attr("_hasDrawn",0)}})}var transactionLoading=0;function addTransaction(o){if(1!=transactionLoading){transactionLoading=1;var n=$("#table-transactioninfo");Cy.ajax(backtestAPI.transactionInfo+"?backtestId="+backtestId+"&offset="+transactionOffset+"&dateOffset="+transactionDateOffset,{success:function(t){if(403==t.code&&n.html("<tr><td>无权限查看</td></tr>"),t.data.transaction.length<=0)1==t.data.status&&(transactionLoading=0);else{for(var e=0;e<t.data.transaction.length;e++){var a=t.data.transaction[e];0!=a.amount&&("string"==typeof a.total&&-1<a.total.indexOf("(")&&(a.total=a.total.match(/\((.+)\)/)[1]),n.jqGrid("addRowData",e,a,"last")),transactionDateOffset=a.tradeDate?a.tradeDate:a.date}if(n.jqGrid("sortGrid","date",!0),bindGroupEvent(n),o&&$("#tab-transactioninfo").find(".ui-jqgrid-bdiv").scrollTop(o),t.data.max){var i='<div class="backtest-detail__bottom-export">                        页面仅展示前1000条记录，查看全部请                        <span class="logdaochu"                            type="transaction"                            backtestId="'+backtestId+'"                        >导出交易详情</span>                    </div>';$("#table-transactioninfo").after(i)}else transactionOffset+=t.data.transaction.length,transactionLoading=0}}})}}function initPosition(){addPosition(),$("#table-positioninfo").height()<$(".transaction-info-pane").eq(1).height()&&setTimeout(initPosition,5e3)}var positionDateOffset=startDate;function fillPosition(){$("#tab-positioninfo").attr("_hasDrawn",1),Cy.ajax(backtestAPI.positionInfo+"?backtestId="+backtestId,{success:function(t){var e=$("#table-positioninfo");if(403==t.code&&e.html("<tr><td>无权限查看</td></tr>"),"0"!==t.data.status){for(var a=new Array,i=0;i<t.data.position.length;i++)a.push(t.data.position[i]),positionDateOffset=t.data.position[i].date;if(0===a.length&&e.hasClass("is-exceed"))return e.empty();var o=drawPositioninfo(a);if(positionOffset=t.data.position.length,o.sortGrid("stock",!0,"desc"),bindGroupEvent(o),t.data.max){var n='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="position"                        backtestId="'+backtestId+'"                    >导出每日持仓&收益</span>                </div>';e.after(n)}else $("#tab-positioninfo").find(".ui-jqgrid-bdiv").scroll(function(){nScrollHight=$(this)[0].scrollHeight,nScrollTop=$(this)[0].scrollTop,nScrollTop+570>=nScrollHight&&addPosition(nScrollTop)}),1==t.data.status&&initPosition()}else setTimeout(fillPosition,3e3)},fail:function(t){$("#tab-positioninfo").attr("_hasDrawn",0)}})}var positionLoading=0;function addPosition(i){if(1!=positionLoading){positionLoading=1;var o=$("#table-positioninfo");Cy.ajax(backtestAPI.positionInfo+"?backtestId="+backtestId+"&offset="+positionOffset+"&dateOffset="+positionDateOffset,{success:function(t){if(403==t.code&&o.html("<tr><td>无权限查看</td></tr>"),t.data.position.length<=0)1==t.data.status&&(positionLoading=0);else{for(var e=0;e<t.data.position.length;e++)o.jqGrid("addRowData",e,t.data.position[e],"last"),positionDateOffset=t.data.position[e].date;if(o.jqGrid("sortGrid","stock",!0),bindGroupEvent(o),i&&$("#tab-positioninfo").find(".ui-jqgrid-bdiv").scrollTop(i),t.data.max){var a='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="position"                        backtestId="'+backtestId+'"                    >导出每日持仓&收益</span>                </div>';$("#table-positioninfo").after(a)}else positionOffset+=t.data.position.length,positionLoading=0}}})}}var riskLength=0,riskQueryCount=0;function fillRisk(){Cy.ajax("/algorithm/backtest/risk?backtestId="+backtestId,{success:function(t){if(t.data){$(".risk-loading").remove();var e=t.data.risk;0!=e||0!=riskLength?(riskLength+=e.algorithmPeriodReturn.length,drawAlgorithmPeriodReturn(e.algorithmPeriodReturn),drawBenchmarkPeriodReturn(e.benchmarkPeriodReturn),drawAlpha(e.alpha),drawBeta(e.beta),drawSharp(e.sharp),drawSortino(e.sortino),drawInformation(e.information),drawAlgovolatility(e.algovolatility),drawBenchmarkvolatility(e.benchmarkvolatility),drawMaxdrawdown(e.maxdrawdown),$(".risk-tab").attr("_hasDrawn",1)):++riskQueryCount<=5&&setTimeout(fillRisk,2200)}else setTimeout(fillRisk,2200)}})}function bindGroupEvent(t){t.find(".jqheader").click(function(){var t=this.id;return $(this.parentNode.parentNode).jqGrid("groupingToggle",t),!1}),t.find(".ui-icon-circlesmall-plus").click(function(){$(this.parentNode.parentNode).trigger("click")});var e=t.attr("id");$(".expand-all-link[tableId="+e+"]").click(function(){var t=$(this).attr("tableId");$("#"+t+" .ui-icon-circlesmall-plus").each(function(){$(this).trigger("click")})}),$(".collapse-all-link[tableId="+e+"]").click(function(){var t=$(this).attr("tableId");$("#"+t+" .ui-icon-circlesmall-minus").each(function(){$(this).trigger("click")})})}function isTanChuang(){var t=backtestAPI.nullBacktestLive;t&&Cy.ajax(t,{success:function(t){"00000"===t.code&&$(".tanceng").removeClass("hidden")}})}function enableLiveTrade(){0<$("#new-algorithm").attr("_remainCount")&&($("#new-algorithm").removeClass("disabled"),$("#new-algorithm").attr("data-target","#myModal"))}function enableShare(){0==accessControl&&$("#share-backtest-button").removeClass("disabled")}initChart(function(){timeoutSpan=2e3,cycleCheck()}),$(".x-new").click(function(){$(".tanceng").addClass("hidden")});var getToday=function(){var t=new Date,e=t.getMonth()+1,a=t.getDate();return e<=9&&(e="0"+e),a<=9&&(a="0"+a),t.getFullYear()+"-"+e+"-"+a};function getByteLen(t){for(var e=0,a=0;a<t.length;a++){null!=t.charAt(a).match(/[^\x00-\xff]/gi)?e+=15:e+=7}return e}function Left(){var t=getByteLen($("#title-box").text());$("#title-box").width()>=t?$(".icon-edit").css({left:t+14}):$(".icon-edit").css({left:"calc(100% - 248px)"})}$("body").delegate(".modify-backtest-name","keyup",function(){var t=$(this),e=t.val();if(!/^[a-zA-Z0-9\u4e00-\u9fa5\()@_\-\.:\/\s']+$/.test(e))return e=e.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\()@_\-\.:\/\s']/g,""),t.val(e),!1}),$(".icon_edit").click(function(t){var e=$(this.parentNode).find("#title-box").eq(0).text(),n=$(this).attr("_backtestId"),s=this;return BootstrapDialog.show({title:"修改回测名称",message:'名称： <input id="name" type="text" class="form-control modify-backtest-name" value="'+e+'" style="width:80%;margin-bottom:10px"><br/></div>',buttons:[{label:"提交",action:function(e){var t=e.getModalBody().find("#name"),a=t.val(),i=$("#title-box").text(),o=a||i;if((a=a.replace(/\s/g,""))&&!/^\S{1,100}$/.test(a))BootstrapDialog.show({title:"提示",message:"名称过长，请重新输入。",onhidden:function(){t.val(i)}});else{if(!a)return BootstrapDialog.show({title:"提示",message:"名称不能为空",onhidden:function(){t.val(i)}}),!1;Cy.ajax("/algorithm/backtest/setName",{data:"backtestId="+n+"&name="+o,success:function(t){return $(s.parentNode).find("#title-box").eq(0).text(o),e.close(),!1},fail:function(t){e.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})}}},{label:"取消",action:function(t){t.close()}}],onshown:function(t){}}),t.stopPropagation(),!1}),$("body").hasClass("mobile")&&Left();var evt="onorientationchange"in window?"orientationchange":"resize";function mobile(){var t=$(".dailybars-output").height();$(".after").height(t),$("#backtest-menu-more").click(function(){t=$(".dailybars-output").height(),$(".after").height(t),"block"==$("#result-area").css("display")?$("#result-area").css({display:"none"}):$("#result-area").css({display:"block"})}),$("#result-tabs").click(function(){$(this).parent().css({display:"none"})}).next(".after").click(function(){$(this).parent().css({display:"none"})});var e=$(window).width();$(".dailybars-output").width(e).css({overflow:"auto"})}window.addEventListener(evt,function(){Left()},!1),$("body").hasClass("mobile")&&mobile(),$(".title_item").click(function(){$(".title_item").removeClass("actives"),$(this).addClass("actives"),fillTransaction()}),$("#btn-attributionAnaly").click(function(){var e=$(this).attr("backtestId"),a=window.open(),i=$(this).attr("accessKey");return Cy.ajax("/community/post/userInfo",{success:function(t){"00000"===t.code?t.data.vipType?Cy.ajax("/algorithm/backtest/submitAttribution?backtestId="+e,{success:function(t){a.location.href=i?"/algorithm/backtest/attributionAnaly?backtestId="+e+"&accessKey="+i:"/algorithm/backtest/attributionAnaly?backtestId="+e}}):(BootstrapDialog.alert("此功能目前仅限聚宽会员免费试用！"),a.close()):(BootstrapDialog.alert(t.msg),a.close())}}),!1});var algorithmDetail={initBaseData:function(){this.$fullBacktestBenchmark=$(".full_backtest_benchmark"),this.backtestId=$("#backtestTpl").data("backtestid")},fetchBenchmark:function(){var a=this;Cy.ajax("/algorithm/backtest/benchmarkName",{type:"get",data:{backtestId:this.backtestId},success:function(t){if("0"==t.status&&t.data&&t.data.benchmark){var e=t.data.benchmark;a.$fullBacktestBenchmark.data("benchmark",!0).attr("title",e).text(e)}}})},tryUpdateBenchmark:function(){this.$fullBacktestBenchmark.data("benchmark")||(this.fetchBenchmark(),setTimeout(this.tryUpdateBenchmark.bind(this),3e3))},init:function(){this.initBaseData(),this.tryUpdateBenchmark()}};$(document).ready(function(){$("#clickDrapdown").hover(function(){g_isMobile||($(this).addClass("checked"),$(this).find(".open_span").addClass("open"),$(".clickDrapdown").removeClass("hidden"))},function(){g_isMobile||"true"==$(this).attr("clicked")||($(this).removeClass("checked"),$(this).find(".open_span").removeClass("open"),$(".clickDrapdown").addClass("hidden"))}),$("#clickDrapdown").click(function(){if(!g_isMobile)if("true"==$(this).attr("clicked"))$(this).attr("clicked","false");else if("false"==$(this).attr("clicked"))return void $(this).attr("clicked","true");$(this).toggleClass("checked"),$(this).find(".open_span").toggleClass("open"),$(".clickDrapdown").toggleClass("hidden")}),algorithmDetail.init()});var g_isBackToTop=!1;function handleAddExportZipSuccess(t){dataZipStatusInterval=setInterval(function(){getExportStatus(t,getExportStatusUrl)},exportFrequency)}$("body").delegate(".logdaochu","click",function(){var t=$(this).attr("backtestId"),e=$(this).attr("type");$(this).text();handleAddExportZip(t,e,handleAddExportZipSuccess)});var addExportZipUrlMap=$.extend({transaction:"/algorithm/backtest/addExportZip",log:"/algorithm/backtest/addExportZip",position:"/algorithm/backtest/addExportZip"},window.addExportZipUrlMapByAccess||{}),getExportStatusUrl="/algorithm/backtest/getExportStatus",getExportZipUrl=window.getExportZipUrlByAccess||"/algorithm/backtest/getExportZip",dataZipStatusInterval,exportFrequency=2e3,isExportZiping=!1,handleAddExportZip=function(t,e,a){if(addExportZipUrlMap[e]&&!isExportZiping){isExportZiping=!0,Cy.ajax(addExportZipUrlMap[e],{data:{backtestId:t,type:e,useCredit:0},creditsModal:{title:{transaction:"导出交易详情",position:"导出持仓&收益",log:"导出日志"}[e],content:$("#title-box").text()},type:"get",success:function(t){isExportZiping=!1,successCallback(t,function(t){$("body").loading({loadingWidth:240,title:"",name:"downloadData",discription:"结果压缩打包中, 请稍后",direction:"column",type:"origin",originDivWidth:40,originDivHeight:40,originWidth:6,originHeight:6,smallLoading:!1,loadingMaskBg:"rgba(0,0,0,0.2)"}),a&&a(t)})},fail:function(t){isExportZiping=!1,errorCallback(t)}})}},getExportStatus=function(e){Cy.ajax(getExportStatusUrl,{data:{task:e},type:"get",success:function(t){successCallback(t,function(t){"string"==typeof t&&(t=parseInt(t),clearInterval(dataZipStatusInterval),1===t?(removeLoading("downloadData"),getExportZip(e)):2===t&&(removeLoading("downloadData"),errorCallback({msg:"当前策略没有产生日志!"})))})},fail:function(t){clearInterval(dataZipStatusInterval),errorCallback(t)}})},getExportZip=function(t){window.location.href=[getExportZipUrl,"task="+t].join("?")},successCallback=function(t,e){"00000"===t.code?e&&e(t.data):BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"错误:"+t.msg})},errorCallback=function(t){t&&BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"下载失败:"+t.msg})};
!function(){var e=$("body"),o=$(".run-time-popover-html"),t=0,r=$(".run-time-info-icon").on("mouseenter",function(){r.popover("show")}).on("mouseleave",function(){var e=$(this);t=setTimeout(function(){e.popover("hide")},300)}),n='<p>今日已运行时长：{{used}}分钟；免费可用时长：{{free}}分钟</p><p>回测结束计算时长，超出部分每30分钟需消耗2积分，积分为负时无法新建回测</p><p>回测开启后将运行至结束(最长3天)，可在右下角选择关闭</p><p><a href="/view/vip/charge" target="_blank">点击延长免费回测时间</a></p>';e.delegate(".run-time-popover-html","mouseenter",function(){clearTimeout(t)}),e.delegate(".run-time-popover-html","mouseleave",function(){r.popover("hide")}),r.popover({placement:"bottom",trigger:"manual",html:!0,content:o}),function a(){$.ajax({type:"POST",url:"/algorithm/index/statistics",dataType:"json",success:function(e){var t=e.data.duration;r.attr("data-over",t.used>t.free?"1":"0"),o.html(Mustache.render(n,t)),setTimeout(function(){a()},6e4)}})}()}();var $backtestProgressLabel=$("#backtest-progress-label"),$dailybarsProgressLabel=$("#dailybars-progresslabel");function fetchBacktestRunTime(e,a){if(!e)return!1;$.ajax({type:"GET",url:"/algorithm/backtest/runTimeInfo",data:{backtestId:e},dataType:"json",success:function(e){var t=e.data;$backtestProgressLabel.text(t.untilNowSec),$dailybarsProgressLabel.text(t.untilNowSec),a&&a(t)}})}